@model PGM.Web.Areas.PGM.Models.MonthlySalaryInfo.MonthlySalaryViewModel
@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/PGM/Views/Shared/_Layout.cshtml";
}
<script src="@Url.Content("~/Scripts/jquery.jqGrid.addons-4.1.2.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.unobtrusive-ajax.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/listEditor.js")" type="text/javascript"></script>
<style>
    div.button-center {
        text-align: center;
    }

    #btnConfirm {
        background-color: white;
        color: forestgreen;
        margin-top: 2px;
        font-size: large;
    }
</style>
@using (Ajax.BeginForm("GetDetailList", "MonthlySalary", new AjaxOptions { HttpMethod = "POST" }, new { id = "frm" }))
{
    <fieldset>
        <div class="GroupBox">
            <div id="message">
                @if (!string.IsNullOrEmpty(Model.Message))
                {
                    <div class="success">
                        @Model.Message
                    </div>
                }
            </div>
        </div>

        <fieldset>
            <div id="jqSearch">

            </div>
        </fieldset>
        <fieldset>
            <div class="button-center" style="height:50px;width:300px;" id="divConfirmation">
            </div>
        </fieldset>
        <table id="jqGrid" cellpadding="0" cellspacing="0"></table>
        <div id="jqGridPager" style="text-align: center;">
        </div>
        <div id="divList">
            @Html.Partial("_DetailGridList", Model)
        </div>
        &nbsp;
    </fieldset>
}
@*<div class="col-sm-9 col-sm-offset-3 text-right">
    <a href="#" id="btnVoucherPosting" class="btn btn-success"> <i class="fa fa-file-powerpoint-o"></i> Prepare Voucher</a>
</div>*@

    <div class="col-sm-11 col-sm-offset-1 text-right" id="voucherButton">
        <div class="row">
                <span class="label">
                    @Html.LabelFor(model => model.ApproverId)<label class="required-field">*</label>
                </span>
                <span class="field">
                    @Html.DropDownListFor(m => m.ApproverId, Model.ApproverList, @String.Format("{0}", Content.DDLOptionalLabel()))
                </span>

                <span class="label-right">
                    @Html.LabelFor(model => model.CPFApproverId)<label class="required-field">*</label>
                </span>
                <span class="field">
                    @Html.DropDownListFor(m => m.CPFApproverId, Model.CPFApproverList, @String.Format("{0}", Content.DDLOptionalLabel()))
                </span>

            </div>
        <button type="submit" class="btn btn-success" id="btnVoucherPosting" onclick="SalaryVoucherPosting()"><i class="fa fa-file-powerpoint-o"></i> Prepare Salary Voucher</button>
        <button type="submit" class="btn btn-success" id="btnLoanVoucherPosting" onclick="CPFVoucherPosting()"><i class="fa fa-file-powerpoint-o"></i> Prepare CPF Voucher</button>
        @*<button type="submit" class="btn btn-success" id="btnPFLoanVoucherPosting" onclick="PFLoanVoucherPosting()"><i class="fa fa-file-powerpoint-o"></i> Prepare PF Loan Voucher</button>
        <button type="submit" class="btn btn-success" id="btnPFVoucherPosting" onclick="PFVoucherPosting()"><i class="fa fa-file-powerpoint-o"></i> Prepare PF Contribution Voucher</button>*@
    </div>
    <div class="row button-crude button-left">
        @Html.ActionLink("Back to List", "Index")
    </div>
<script>
    var flag = false;
    $(document).ready(function () {

        var isConfirmed = $('#hfIsConfirmed').val();
        ToggleButton(isConfirmed);

    });

    function GoToConfirmation() {
        var data = {
            year: $("#hfSalaryYear").val(),
            month: $("#hfSalaryMonth").val()
        };

        var url = '@Url.Action("ConfirmMonthlySalary", "MonthlySalary")';

        if (confirm('Do you want to confirm salary for this month?')) {
            $.post(url, { year: $("#hfSalaryYear").val(), month: $("#hfSalaryMonth").val() }, function (obj) {
                console.log(obj);
                if (obj.success == true) {
                    ToggleButton('true');
                    $('#hfIsConfirmed').val(true);
                }
                else {
                    alert('--Something wrong!--');
                }
            }, "json");
        }

    }

    function ToggleButton(result) {

        if (result.toLowerCase() === 'true') {
            $("#divConfirmation").html("Confirmed!");
            $(".button-center").css({
                'color': 'green',
                'font-size': 'large'

            });
            $("#voucherButton").show();
        }
        else {
            var $button = $('<input/>').attr({ type: 'button', name: 'btnConfirm', value: 'Confirm', class: 'btn btn-success btn-lg', onclick: 'GoToConfirmation()', id: 'btnConfirm' });
            $("#divConfirmation").html($button);
            $("#voucherButton").hide();
        }
    }

    function SalaryVoucherPosting() {
        var year = $("#hfSalaryYear").val();
        var month = $("#hfSalaryMonth").val();
        var ApproverId = $("#ApproverId").val();

        if (year == "" && month == "") {
            alert('Before prepare voucher, please process salary for this month.');
            return false;
        }
        var isConfirm = $('#hfIsConfirmed').val();
        if (isConfirm.toLowerCase() != 'true') {
            alert('Before prepare voucher, please confirm salary for this month.');
            return false;
        }
        if (ApproverId == "" || ApproverId == "0") {
            alert('Before prepare voucher, please select Recommender/Approver.');
            return false;
        }


        var url = '@Url.Action("SalaryVoucherPosting", "MonthlySalary")?year=' + year + '&month=' + month + '&ApproverId='+ ApproverId;

        $.ajax({
            url: url,
            type: 'POST',
            success: function (result) {
                if (result.result != undefined) {
                    alert(result.result);
                }
                else {
                    alert(result.result);
                }
            },
            error: function () {
                alert('System is unable to load data please try again.');
            }
        });
    }

    function CPFVoucherPosting() {
        var year = $("#hfSalaryYear").val();
        var month = $("#hfSalaryMonth").val();
        var ApproverId = $("#CPFApproverId").val();

        if (year == "" && month == "") {
            alert('Before prepare voucher, please process salary for this month.');
            return false;
        }
        var isConfirm = $('#hfIsConfirmed').val();
        if (isConfirm.toLowerCase() != 'true') {
            alert('Before prepare voucher, please confirm salary for this month.');
            return false;
        }
        if (ApproverId == "" || ApproverId == "0") {
            alert('Before prepare voucher, please select Recommender/Approver for CPF.');
            return false;
        }

        var url = '@Url.Action("CPFVoucherPosting", "MonthlySalary")?year=' + year + '&month=' + month + '&ApproverId='+ ApproverId;

        $.ajax({
            url: url,
            type: 'POST',
            success: function (result) {
                console.log(result);
                if (result.result != undefined) {
                    alert(result.result);
                }
                else {
                    alert(result.result);
                }
            },
            error: function () {
                alert('System is unable to load data please try again.');
            }
        });
    }

    function PFVoucherPosting() {

        var year = $("#hfSalaryYear").val();
        var month = $("#hfSalaryMonth").val();
        if (year == "" && month == "") {
            alert('Before prepare voucher, please process salary for this month.');
            return false;
        }
        var isConfirm = $('#hfIsConfirmed').val();
        if (isConfirm.toLowerCase() != 'true') {
            alert('Before prepare voucher, please confirm salary for this month.');
            return false;
        }
        var url = '@Url.Action("PFVoucherPosting", "MonthlySalary")?year=' + year + '&month=' + month;
        $.ajax({
            url: url,
            type: 'POST',
            success: function (result) {
                if (result.redirectUrl != '') {
                    window.location.href = result.redirectUrl;
                }
            },
            error: function () {
                alert('System is unable to load data please try again.');
            }
        });
    }

    function PFLoanVoucherPosting() {

        var year = $("#hfSalaryYear").val();
        var month = $("#hfSalaryMonth").val();
        if (year == "" && month == "") {
            alert('Before prepare voucher, please process salary for this month.');
            return false;
        }
        var url = '@Url.Action("PFLoanVoucherPosting", "MonthlySalary")?year=' + year + '&month=' + month;
        $.ajax({
            url: url,
            type: 'POST',
            success: function (result) {
                if (result.redirectUrl != '') {
                    window.location.href = result.redirectUrl;
                }
            },
            error: function () {
                alert('System is unable to load data please try again.');
            }
        });
    }
</script>